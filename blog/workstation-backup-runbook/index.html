<!doctype html><html class=nojs lang=pt-br dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width"><title>Configurando backups (esta√ß√£o de trabalho) ‚Äì Vereda Tecnologia</title><meta name=description content="Prop√≥sito Configurar o programa de backup para replicar dados para nuvem e aplicar prote√ß√£o contra ransomware. Este procedimento satisfaz a regra de ouro 3-2-1-1-0 e ‚Ä¶"><meta name=created content="2022-12-18T18:56:16-0300"><meta name=modified content="2022-12-18T18:56:16-0300"><meta property="og:site_name" content="Vereda Tecnologia"><meta property="og:title" content="Configurando backups (esta√ß√£o de trabalho)"><meta property="og:url" content="https://www.vereda.tec.br/blog/workstation-backup-runbook/"><meta property="og:type" content="article"><meta name=generator content="Hugo 0.104.3"><meta name=msapplication-TileColor content="#da8020"><meta name=theme-color content="#da8020"><link rel=canonical href=https://www.vereda.tec.br/blog/workstation-backup-runbook/><link rel=apple-touch-icon href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest><link rel=stylesheet href=/css/styles.653cf5c7bbdab4ef702592e75dbaac4eddcf76180f4f2621e465c0f1e004fd7e.css><link rel=stylesheet href=/css/print.c44e36c38770a06d7a3e314d59b503dd8fadcd356b709f8673f131c88b4e684e.css media=print><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Configurando backups (esta√ß√£o de trabalho)","datePublished":"2022-12-18T18:56:16-03:00","dateModified":"2022-12-18T18:56:16-03:00","url":"https://www.vereda.tec.br/blog/workstation-backup-runbook/","description":"Prop√≥sito Configurar o programa de backup para replicar dados para nuvem e aplicar prote√ß√£o contra ransomware. Este procedimento satisfaz a regra de ouro 3-2-1-1-0 e ‚Ä¶","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.vereda.tec.br/"},"publisher":{"@type":"Organization","name":"Vereda Tecnologia","url":"https://www.vereda.tec.br/"}}</script><script src=/js/script-early.min.21220209af63c496c7531316922ef9a4548661be9388bbcd1f9899bb0b842b21.js></script>
<script defer src=/js/lib/umbrella.min.f441cd0957482aa1fca749d678691f7e9bc427613bd52d0c4ee746ba8f7ea500.js></script>
<script defer src=/js/script.min.f8f04035e9a9424ebc267c1a5fdb513d79b611a04b85cab2ac414d091ac9e94c.js></script></head><body class=single-page><div class="page layout__page layout__sidebar-second"><header class="header layout__header"><a href=/ title=Home rel=home class=header__logo><img src=/ipe-amarelo.png alt=Home class=header__logo-image></a><h1 class=header__site-name><a href=/ title=Home class=header__site-link rel=home><span>Vereda Tecnologia</span></a></h1><div class="region header__region"><h2 class=visually-hidden>Seletor de idioma</h2><nav class="language-selector layout__language-selector"><svg version="1.0" xmlns="http://www.w3.org/2000/svg" class="language-icon" width="24" height="24" viewBox="0 0 961 1113"><path d="M848 3A17654 17654 0 00499 121l-39 13-6 2-171-60-173-62c-2 0-2 6-2 118v119l-50 16-53 19c-5 3-5-19-5 343 0 335 0 336 2 339l6 5a92499 92499 0 00459-150l12-4 10 3 467 148 4 2V302l-45-15-45-14-1-132c0-124-1-132-2-134-4-7-9-8-19-5zm-4 145-1 117-178-57-178-57L843 30l1 118zM458 481l-1 319-216 72-216 72V305l215-72 217-72 1 320zm262-131c17 4 30 9 30 9 1 0 20 67 42 149l57 203 15 56-64-19a2060 2060 0 01-24-84 2094 2094 0 00-130-40l-15 33-14 34-64-18 22-55 55-136 46-112c10-24 13-30 14-30l31 10z"/><path d="M257 360l-35 9c-23 7-25 7-34 7a72 72 0 01-20-3c-1 1 2 11 5 18 4 8 13 17 23 21 6 3 7 3 18 3 19 0 37-6 52-17 12-8 16-18 15-29-2-11-8-13-24-9zm78 53-35 16c-13 7-23 12-28 13l-38 12a1636 1636 0 01-106 32c-19 3-17 2-17 9l2 8c2 4 9 10 14 12 12 6 42 3 51-6 2-2 3-3 3-7v-6l31-10 40-11a515 515 0 0148-13l-48 96c-10 19-23 40-45 71l-52 71-55 64-7 8h4c7 0 17-2 20-4a929 929 0 00149-179l23 17c26 20 30 23 51 35 25 14 39 21 56 27 8 2 12 3 13 1 1-4-6-30-9-33l-26-12-47-20-40-17-16-7 10-17c22-35 34-56 53-95l20-40 1-10v-11h-3l-17 6zm381 38-23 56-23 55 86 26a4814 4814 0 00-40-137zM680 972a460 460 0 0026 44 422 422 0 01-319 66 517 517 0 01-175-66c-7-3-14-2-17 4-2 3-2 9 0 12s24 16 46 27a536 536 0 00222 53c36 1 39 0 68-4a480 480 0 00181-65l8-5 12 21 13 19 7-19 17-48 10-32-99-7z"/></svg><ul class=navbar><li><a rel=alternate href=/en hreflang=en-us lang=en-us>English</a></li></ul></nav></div></header><nav class="main-menu layout__navigation"><h2 class=visually-hidden>Menu principal</h2><ul class=navbar><li><a href=/>Home</a></li><li><a href=/blog/ class=active aria-current=page>Blog</a></li></ul></nav><main class="main layout__main"><article class="single-view single-view--blog"><header><h1 class="title title-submitted">Configurando backups (esta√ß√£o de trabalho)</h1><div class=submitted><time class=created-date datetime=2022-12-18T18:56:16-03:00>18 December, 2022</time></div></header><div class=content><h1 id=prop√≥sito>Prop√≥sito</h1><p>Configurar o programa de backup para replicar dados para nuvem e aplicar prote√ß√£o contra ransomware.</p><p>Este procedimento satisfaz a <a href=https://web.archive.org/web/20221108104150/https://community.veeam.com/blogs-and-podcasts-57/3-2-1-1-0-golden-backup-rule-569>regra de ouro 3-2-1-1-0</a> e protege os dados do usu√°rio contra <strong>amea√ßas</strong>:</p><ol><li>Falha humana (esquecimento, descuido, desconhecimento, etc)</li><li>Roubo e/ou furto</li><li>Falha de m√≠dia (f√≠sica e/ou l√≥gica)</li><li>Cat√°strofe local (inc√™ndio, inunda√ß√£o, etc)</li><li>Malware (ransomware)</li></ol><p>Validar o procedimento pressup√µe sucesso em:</p><ul><li>Recupera√ß√£o pontual de determinado arquivo em vers√£o espec√≠fica, sem necessitar de acesso √† internet.</li><li>Recupera√ß√£o de todos os dados do usu√°rio para um novo dispositivo usando c√≥pia em nuvem ou local, como m√≠dia remov√≠vel ou <a href=https://web.archive.org/web/20221218233749/https://www.qnapbrasil.com.br/blog/post/o-que-e-nas-network-attached-storage>NAS</a>.</li></ul><h1 id=contexto>Contexto</h1><p>Softwares e fornecedores utilizados:</p><ul><li>O <a href=https://www.borgbackup.org/>Borgbackup</a> √© usado para backup <strong>incremental</strong>;</li><li>O <a href=https://vorta.borgbase.com/>Vorta</a> √© usado como agendador e fornece uma interface gr√°fica para intera√ß√£o com o Borg;</li><li>O <a href=https://rclone.org/>Rclone</a> √© usado para sincroniza√ß√£o entre os reposit√≥rios no sistema de arquivos local e o armazenamento em nuvem;</li><li>A <a href=https://www.backblaze.com/b2/cloud-storage.html>Backblaze</a> √© usado como fornecedor de armazenamento em nuvem;</li><li>O <a href=https://ntfy.sh>ntfy.sh</a> √© usado como canal de notifica√ß√£o com o resultado de cada execu√ß√£o de backup;</li></ul><p>Depois de configurado, o Vorta executa na √°rea de trabalho em segundo plano e, no hor√°rio agendado, inicia a rotina de backup. Em caso de sucesso, o script de p√≥s-backup √© executado tamb√©m.</p><p>A rotina de backup √© operada pelo Borg, que salva uma vers√£o de todos os arquivos selecionados dentro do reposit√≥rio local (no mesmo sistema de arquivos)</p><p>O script de p√≥s-backup sincroniza o reposit√≥rio local com a nuvem, aumenta a validade da prote√ß√£o contra ransomware e por fim envia uma notifica√ß√£o com o resultado da execu√ß√£o.</p><h1 id=passo-a-passo>Passo-a-passo</h1><p>Em um sistema Debian stable, instale os programas abaixo:</p><p><code>apt install vorta borg rclone backblaze-b2 curl python3</code></p><p>Apenas para refer√™ncia, abaixo est√° a vers√£o espec√≠fica dos softwares:</p><ul><li>backblaze-b2 1.3.8-4</li><li>borg 1.1.16-3</li><li>curl 7.74.0-1.3+deb11u3</li><li>debian stable 11.6</li><li>linux-image-5.10.0-20-amd64 (5.10.158-2)</li><li>python3 3.9.2-3</li><li>rclone 1.53.3-1+b6</li><li>vorta client 0.7.5-1</li></ul><p>Nota: O procedimento foi validado com o sistema operacional e softwares mencionados acima, mas esse procedimento provavelmente funciona em qualquer sistema linux ou demais sistemas suportados pelo Borg Backup.</p><h2 id=vorta-profile>Vorta Profile</h2><p>Execute o programa Vorta e crie seu reposit√≥rio local. Esta p√°gina tem um guia de 5 minutos para faz√™-lo a partir do passo 2: <a href=https://web.archive.org/web/20221217124626/https://vorta.borgbase.com/usage/local/#step-2---setting-up-local-repository>Setting up Vorta for Local Backups</a></p><p>Ap√≥s configurar o reposit√≥rio, ajuste as demais configura√ß√µes do seu perfil como a seguir:</p><p><strong>Schedule tab/Schedule</strong></p><blockquote><p>üîò Backup every <strong>1</strong> hours at <strong>17</strong> minutes past the hour</p><p>‚úÖ Validate repository data every <strong>1</strong> weeks</p><p>‚úÖ Prune old Archives after each backup</p></blockquote><p>Nota: A configura√ß√£o acima √© exemplificativa. Caso queira, pode alterar os n√∫meros em negrito.</p><p><strong>Schedule tab/Shell Commands</strong></p><blockquote><p>Pre-backup command to run BEFORE backups: <code>test -x /home/user/.local/share/Vorta/post-backup_init</code></p><p>Post-backup command to run AFTER backups: <code>/home/user/.local/share/Vorta/post-backup_init 2>&1 | tee -a /home/user/.cache/Vorta/log/vorta.log</code></p></blockquote><p>Nota: substitua a palavra <code>user</code> nos comandos acima pelo nome do seu usu√°rio.</p><p>Dica: em um terminal, execute <code>echo $LOGNAME</code> para conferir o nome do seu usu√°rio.</p><blockquote><p>Arguments to add: <code>--umask 0022 --noatime</code></p></blockquote><p><strong>Archives tab/Prune Options and Archive Naming</strong></p><blockquote><p>Prune Options: Keep <strong>6</strong> hourly, <strong>3</strong> daily, <strong>4</strong> weekly, <strong>2</strong> monthly and <strong>0</strong> annual archives. No matter what, keep all archives of the last <strong>2H</strong>.</p><p>Archive Name: <code>{profile_slug}-{now:%Y-%m-%d-%H%M}</code></p><p>Prune Prefix: <code>{profile_slug}-</code></p></blockquote><p>Nota: A configura√ß√£o acima √© exemplificativa. Caso queira, pode alterar os n√∫meros em negrito.</p><h2 id=instalar-scripts-personalizados>Instalar scripts personalizados</h2><p>Junto com este documento encontram-se os arquivos post-backup_init e post-backup_renew-lock.py. Copie-os para o caminho /home/user/.local/share/Vorta/</p><p>Ap√≥s a c√≥pia, aplique permiss√µes de execu√ß√£o no arquivo post-backup_init, como abaixo:</p><p><code>chmod +x /home/$LOGNAME/.local/share/Vorta/post-backup_init</code></p><p>Nota: A pasta .local √© oculta por padr√£o. Caso necess√°rio, habilite a visualiza√ß√£o de arquivos ocultos no seu gerenciador de arquivos.</p><h2 id=obter-token-v√°lido-na-backblaze>Obter token v√°lido na backblaze</h2><p>Primeiro, crie um bucket exclusivo para os backups deste dispositivo. Escolha um nome globalmente √∫nico, de prefer√™ncia seguindo alguma padroniza√ß√£o interna (tal como nomedaempresa-hostname-backups).</p><p>Lembre-se de habilitar a op√ß√£o de trava de objetos! Como n√£o pretendo compartilhar esses arquivos com ningu√©m fora da minha organiza√ß√£o e eu sempre aplico criptografia no lado do cliente, mantive essas op√ß√µes no padr√£o. As op√ß√µes de cria√ß√£o do bucket ficaram assim:</p><blockquote><p>Files in Bucket are: Private</p><p>Default Encryption: Disable</p><p>Object Lock: Enable</p></blockquote><p>Ap√≥s criado, ajuste o ciclo de vida dos objetos para remover automaticamente vers√µes antigas.</p><blockquote><p>Lifecycle Settings: Keep only the last version of the file</p></blockquote><p>Segundo, criar uma nova application key com acesso restrito ao bucket criado acima. Habilitar leitura e escrita.</p><p>As credenciais do token ser√£o exibidas na tela. Salve-as em algum lugar seguro pra uso futuro, ou aproveite agora para configurar o rclone. Recomendo usar a <a href=https://rclone.org/commands/rclone_config_create/>documenta√ß√£o oficial</a>.</p><h2 id=receber-notifica√ß√µes-no-celular-opcional>Receber notifica√ß√µes no celular (opcional)</h2><p>Essa √© a parte mais legal na minha opini√£o. Se voc√™ fez tudo certinho at√© aqui, o seu sistema <strong>j√° est√° gerando notifica√ß√µes</strong> ao t√©rmino de cada backup, seja ele bem sucedido ou n√£o. Para acompanhar essas notifica√ß√µes no seu celular, usei um servi√ßo chamado ntfy.sh.</p><p>Baixe o aplicativo pelo F-droid (ou pela fonte de sua prefer√™ncia) e cadastre o acompanhamento do t√≥pico com o nome igualzinho aparece no seu aquivo de configura√ß√£o do rclone. Como aqui usei o padr√£o nomedaempresa-hostname-backup, fica f√°cil acertar o nome do t√≥pico para acompanhar.</p><p>Voc√™ pode visualizar suas configura√ß√µes do rclone com o comando:</p><p><code>rclone config show</code></p><p>O nome da configura√ß√£o usada deve aparecer entre colchetes.</p></div><div class="content content--bottom"></div></article></main><aside class="sidebar layout__second-sidebar"><section><h4 class=menu><a href=/blog/ class=active aria-current=page>Blog</a></h4><ul class=menu><li><a href=/blog/workstation-backup-runbook/ class=active aria-current=page>Configurando backups (esta√ß√£o de trabalho)</a></li><li><a href=/blog/hello-world/>Ol√° Mundo</a></li><li><a href=/blog/vereda/>Vereda</a></li></ul></section></aside><footer class="footer layout__footer"><p>Este site est√° licenciado com uma Licen√ßa <a href=https://creativecommons.org/licenses/by-sa/4.0/>CC-BY-SA 4.0</a>.</p><p>Powered by <a href=https://gohugo.io/>Hugo</a> and the <a href=https://github.com/frjo/hugo-theme-zen>Zen theme</a>.</p></footer></div></body></html>