<!doctype html><html lang=pt-br dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=stylesheet href=/css/style.css><title>Vereda Tecnologia</title><meta name=description content="Prop√≥sito Configurar o programa de backup para replicar dados para nuvem e aplicar prote√ß√£o contra ransomware. Este procedimento satisfaz a regra de ouro 3-2-1-1-0 e ‚Ä¶"><meta name=created content="2022-12-18T18:56:16-0300"><meta name=modified content="2022-12-18T18:56:16-0300"><meta property="og:site_name" content="Vereda Tecnologia"><meta property="og:title" content="Configurando backups (esta√ß√£o de trabalho)"><meta property="og:url" content="https://www.vereda.tec.br/blog/workstation-backup-runbook/"><meta property="og:type" content="article"><meta name=generator content="Hugo 0.104.3"><meta name=msapplication-TileColor content="#da8020"><meta name=theme-color content="#da8020"><link rel=canonical href=https://www.vereda.tec.br/blog/workstation-backup-runbook/><link rel=apple-touch-icon href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest></head><body><header><section><a href=/ title=Home rel=home><img src=/ipe-amarelo.png alt=Home></a><h1><a href=/ title=Home rel=home><span>Vereda Tecnologia</span></a></h1></section><nav><menu><li><a href=/blog>Blog</a></li><li><a href=/>Contato</a></li><li><a href=/>Sobre</a></li><li></li></menu></nav></header><main><header><h1>Configurando backups (esta√ß√£o de trabalho)</h1><p>Por Fernanda Queiroz</p><p><time>2022-12-18</time> | 4 minutes read</p></header><article><h1 id=prop√≥sito>Prop√≥sito</h1><p>Configurar o programa de backup para replicar dados para nuvem e aplicar prote√ß√£o contra ransomware.</p><p>Este procedimento satisfaz a <a href=https://web.archive.org/web/20221108104150/https://community.veeam.com/blogs-and-podcasts-57/3-2-1-1-0-golden-backup-rule-569>regra de ouro 3-2-1-1-0</a> e protege os dados do usu√°rio contra <strong>amea√ßas</strong>:</p><ol><li>Falha humana (esquecimento, descuido, desconhecimento, etc)</li><li>Roubo e/ou furto</li><li>Falha de m√≠dia (f√≠sica e/ou l√≥gica)</li><li>Cat√°strofe local (inc√™ndio, inunda√ß√£o, etc)</li><li>Malware (ransomware)</li></ol><p>Validar o procedimento pressup√µe sucesso em:</p><ul><li>Recupera√ß√£o pontual de determinado arquivo em vers√£o espec√≠fica, sem necessitar de acesso √† internet.</li><li>Recupera√ß√£o de todos os dados do usu√°rio para um novo dispositivo usando c√≥pia em nuvem ou local, como m√≠dia remov√≠vel ou <a href=https://web.archive.org/web/20221218233749/https://www.qnapbrasil.com.br/blog/post/o-que-e-nas-network-attached-storage>NAS</a>.</li></ul><h1 id=contexto>Contexto</h1><p>Softwares e fornecedores utilizados:</p><ul><li>O <a href=https://www.borgbackup.org/>Borgbackup</a> √© usado para backup <strong>incremental</strong>;</li><li>O <a href=https://vorta.borgbase.com/>Vorta</a> √© usado como agendador e fornece uma interface gr√°fica para intera√ß√£o com o Borg;</li><li>O <a href=https://rclone.org/>Rclone</a> √© usado para sincroniza√ß√£o entre os reposit√≥rios no sistema de arquivos local e o armazenamento em nuvem;</li><li>A <a href=https://www.backblaze.com/b2/cloud-storage.html>Backblaze</a> √© usado como fornecedor de armazenamento em nuvem;</li><li>O <a href=https://ntfy.sh>ntfy.sh</a> √© usado como canal de notifica√ß√£o com o resultado de cada execu√ß√£o de backup;</li></ul><p>Depois de configurado, o Vorta executa na √°rea de trabalho em segundo plano e, no hor√°rio agendado, inicia a rotina de backup. Em caso de sucesso, o script de p√≥s-backup √© executado tamb√©m.</p><p>A rotina de backup √© operada pelo Borg, que salva uma vers√£o de todos os arquivos selecionados dentro do reposit√≥rio local (no mesmo sistema de arquivos)</p><p>O script de p√≥s-backup sincroniza o reposit√≥rio local com a nuvem, aumenta a validade da prote√ß√£o contra ransomware e por fim envia uma notifica√ß√£o com o resultado da execu√ß√£o.</p><h1 id=passo-a-passo>Passo-a-passo</h1><p>Em um sistema Debian stable, instale os programas abaixo:</p><p><code>apt install vorta borg rclone backblaze-b2 curl python3</code></p><p>Apenas para refer√™ncia, abaixo est√° a vers√£o espec√≠fica dos softwares:</p><ul><li>backblaze-b2 1.3.8-4</li><li>borg 1.1.16-3</li><li>curl 7.74.0-1.3+deb11u3</li><li>debian stable 11.6</li><li>linux-image-5.10.0-20-amd64 (5.10.158-2)</li><li>python3 3.9.2-3</li><li>rclone 1.53.3-1+b6</li><li>vorta client 0.7.5-1</li></ul><p>Nota: O procedimento foi validado com o sistema operacional e softwares mencionados acima, mas esse procedimento provavelmente funciona em qualquer sistema linux ou demais sistemas suportados pelo Borg Backup.</p><h2 id=vorta-profile>Vorta Profile</h2><p>Execute o programa Vorta e crie seu reposit√≥rio local. Esta p√°gina tem um guia de 5 minutos para faz√™-lo a partir do passo 2: <a href=https://web.archive.org/web/20221217124626/https://vorta.borgbase.com/usage/local/#step-2---setting-up-local-repository>Setting up Vorta for Local Backups</a></p><p>Ap√≥s configurar o reposit√≥rio, ajuste as demais configura√ß√µes do seu perfil como a seguir:</p><p><strong>Schedule tab/Schedule</strong></p><blockquote><p>üîò Backup every <strong>1</strong> hours at <strong>17</strong> minutes past the hour</p><p>‚úÖ Validate repository data every <strong>1</strong> weeks</p><p>‚úÖ Prune old Archives after each backup</p></blockquote><p>Nota: A configura√ß√£o acima √© exemplificativa. Caso queira, pode alterar os n√∫meros em negrito.</p><p><strong>Schedule tab/Shell Commands</strong></p><blockquote><p>Pre-backup command to run BEFORE backups: <code>test -x /home/user/.local/share/Vorta/post-backup_init</code></p><p>Post-backup command to run AFTER backups: <code>/home/user/.local/share/Vorta/post-backup_init 2>&1 | tee -a /home/user/.cache/Vorta/log/vorta.log</code></p></blockquote><p>Nota: substitua a palavra <code>user</code> nos comandos acima pelo nome do seu usu√°rio.</p><p>Dica: em um terminal, execute <code>echo $LOGNAME</code> para conferir o nome do seu usu√°rio.</p><blockquote><p>Arguments to add: <code>--umask 0022 --noatime</code></p></blockquote><p><strong>Archives tab/Prune Options and Archive Naming</strong></p><blockquote><p>Prune Options: Keep <strong>6</strong> hourly, <strong>3</strong> daily, <strong>4</strong> weekly, <strong>2</strong> monthly and <strong>0</strong> annual archives. No matter what, keep all archives of the last <strong>2H</strong>.</p><p>Archive Name: <code>{profile_slug}-{now:%Y-%m-%d-%H%M}</code></p><p>Prune Prefix: <code>{profile_slug}-</code></p></blockquote><p>Nota: A configura√ß√£o acima √© exemplificativa. Caso queira, pode alterar os n√∫meros em negrito.</p><h2 id=instalar-scripts-personalizados>Instalar scripts personalizados</h2><p>Junto com este documento encontram-se os arquivos post-backup_init e post-backup_renew-lock.py. Copie-os para o caminho /home/user/.local/share/Vorta/</p><p>Ap√≥s a c√≥pia, aplique permiss√µes de execu√ß√£o no arquivo post-backup_init, como abaixo:</p><p><code>chmod +x /home/$LOGNAME/.local/share/Vorta/post-backup_init</code></p><p>Nota: A pasta .local √© oculta por padr√£o. Caso necess√°rio, habilite a visualiza√ß√£o de arquivos ocultos no seu gerenciador de arquivos.</p><h2 id=obter-token-v√°lido-na-backblaze>Obter token v√°lido na backblaze</h2><p>Primeiro, crie um bucket exclusivo para os backups deste dispositivo. Escolha um nome globalmente √∫nico, de prefer√™ncia seguindo alguma padroniza√ß√£o interna (tal como nomedaempresa-hostname-backups).</p><p>Lembre-se de habilitar a op√ß√£o de trava de objetos! Como n√£o pretendo compartilhar esses arquivos com ningu√©m fora da minha organiza√ß√£o e eu sempre aplico criptografia no lado do cliente, mantive essas op√ß√µes no padr√£o. As op√ß√µes de cria√ß√£o do bucket ficaram assim:</p><blockquote><p>Files in Bucket are: Private</p><p>Default Encryption: Disable</p><p>Object Lock: Enable</p></blockquote><p>Ap√≥s criado, ajuste o ciclo de vida dos objetos para remover automaticamente vers√µes antigas.</p><blockquote><p>Lifecycle Settings: Keep only the last version of the file</p></blockquote><p>Segundo, criar uma nova application key com acesso restrito ao bucket criado acima. Habilitar leitura e escrita.</p><p>As credenciais do token ser√£o exibidas na tela. Salve-as em algum lugar seguro pra uso futuro, ou aproveite agora para configurar o rclone. Recomendo usar a <a href=https://rclone.org/commands/rclone_config_create/>documenta√ß√£o oficial</a>.</p><h2 id=receber-notifica√ß√µes-no-celular-opcional>Receber notifica√ß√µes no celular (opcional)</h2><p>Essa √© a parte mais legal na minha opini√£o. Se voc√™ fez tudo certinho at√© aqui, o seu sistema <strong>j√° est√° gerando notifica√ß√µes</strong> ao t√©rmino de cada backup, seja ele bem sucedido ou n√£o. Para acompanhar essas notifica√ß√µes no seu celular, usei um servi√ßo chamado ntfy.sh.</p><p>Baixe o aplicativo pelo F-droid (ou pela fonte de sua prefer√™ncia) e cadastre o acompanhamento do t√≥pico com o nome igualzinho aparece no seu aquivo de configura√ß√£o do rclone. Como aqui usei o padr√£o nomedaempresa-hostname-backup, fica f√°cil acertar o nome do t√≥pico para acompanhar.</p><p>Voc√™ pode visualizar suas configura√ß√µes do rclone com o comando:</p><p><code>rclone config show</code></p><p>O nome da configura√ß√£o usada deve aparecer entre colchetes.</p></article></main><footer><p>Este site est√° licenciado com uma Licen√ßa <a href=https://creativecommons.org/licenses/by-sa/4.0/>CC-BY-SA 4.0</a>.</p><p>Feito em S√£o Paulo, Brasil, com <a href=https://gohugo.io/>Hugo</a>; Servido por <a href=https://pages.github.com>Github Pages</a>.</p></footer></body></html>